'use client'

import { useState, useEffect } from 'react'
import toast from 'react-hot-toast'
import { roleService } from '@/services/role.service'
import { Role } from '@/types'
import { useAuthStore } from '@/stores/authStore'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Input } from '@/components/ui/input'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/Table'
import Pagination from '@/components/ui/Pagination'
import { Checkbox } from '@/components/ui/checkbox'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import {
  ShieldCheckIcon,
  PlusIcon,
  PencilIcon,
  TrashIcon,
  UserGroupIcon,
  CheckCircleIcon,
  XCircleIcon,
  MagnifyingGlassIcon,
  ExclamationTriangleIcon,
  ArchiveBoxIcon
} from '@heroicons/react/24/outline'

interface CreateRoleData {
  name: string
  displayName: string
  description: string
  type: 'SYSTEM' | 'TENANT' | 'CUSTOM'
  level: 'SUPER_ADMIN' | 'ADMIN' | 'MANAGER' | 'USER' | 'GUEST'
  isActive: boolean
}

export function RoleManagement({ hasFullAccess }: { hasFullAccess?: boolean }) {
  const [roles, setRoles] = useState<Role[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false)
  const [editingRole, setEditingRole] = useState<Role | null>(null)
  const [formData, setFormData] = useState<CreateRoleData>({
    name: '',
    displayName: '',
    description: '',
    type: 'TENANT',
    level: 'USER',
    isActive: true
  })
  const [currentPage, setCurrentPage] = useState(1)
  const [itemsPerPage] = useState(10)
  const [selectedRoles, setSelectedRoles] = useState<string[]>([])
  const [isAllSelected, setIsAllSelected] = useState(false)
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)
  const [deleteAction, setDeleteAction] = useState<'delete' | 'softDelete'>('delete')
  const [activeTab, setActiveTab] = useState<'active' | 'trash'>('active')
  const [deletedRoles, setDeletedRoles] = useState<Role[]>([])
  const [deletedRolesLoading, setDeletedRolesLoading] = useState(false)
  const [selectedDeletedRoles, setSelectedDeletedRoles] = useState<string[]>([])
  const { currentTenant } = useAuthStore()

  useEffect(() => {
    loadRoles()
    if (activeTab === 'trash') {
      loadDeletedRoles()
    }
  }, [currentTenant])

  useEffect(() => {
    if (activeTab === 'trash') {
      loadDeletedRoles()
    }
  }, [activeTab])

  // Reset pagination when search changes
  useEffect(() => {
    setCurrentPage(1)
  }, [searchTerm])

  const loadRoles = async () => {
    try {
      setLoading(true)
      console.log('ðŸ” Loading roles for tenant:', currentTenant?.id)
      const rolesData = await roleService.getRoles({
        // Note: tenantId parameter will be handled by backend auth middleware
      })
      console.log('ðŸ“¦ Roles data received:', rolesData)
      console.log('ðŸ“Š Roles count:', rolesData?.length)
      setRoles(rolesData)
    } catch (error: any) {
      console.error('âŒ Error loading roles:', error)
      // Set empty roles on error to prevent infinite loading
      setRoles([])
    } finally {
      setLoading(false)
    }
  }

  const loadDeletedRoles = async () => {
    try {
      setDeletedRolesLoading(true)
      const deletedRolesData = await roleService.getDeletedRoles({
        // Note: tenantId parameter will be handled by backend auth middleware
      })
      setDeletedRoles(deletedRolesData)
    } catch (error: any) {
      console.error('Error loading deleted roles:', error)
      setDeletedRoles([])
    } finally {
      setDeletedRolesLoading(false)
    }
  }

  const filteredRoles = roles.filter(role =>
    role.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    role.description?.toLowerCase().includes(searchTerm.toLowerCase())
  )

  // Pagination logic
  const totalPages = Math.ceil(filteredRoles.length / itemsPerPage)
  const startIndex = (currentPage - 1) * itemsPerPage
  const endIndex = startIndex + itemsPerPage
  const paginatedRoles = filteredRoles.slice(startIndex, endIndex)

  // Reset selection when page or search changes
  useEffect(() => {
    setSelectedRoles([])
    setIsAllSelected(false)
  }, [currentPage, searchTerm])

  
  const handleCreateRole = async () => {
    try {
      console.log('ðŸš€ Creating role:', formData)
      const roleData = {
        ...formData,
        tenantId: currentTenant?.id,
        // REMOVED: permissions field - will handle separately
      }
      console.log('ðŸ“¦ Role data to create:', roleData)

      const result = await roleService.createRole(roleData)
      console.log('âœ… Role created successfully:', result)

      setIsCreateDialogOpen(false)
      resetForm()
      loadRoles()
    } catch (error: any) {
      console.error('âŒ Error creating role:', error)
      alert('Error creating role: ' + error.message)
    }
  }

  const handleUpdateRole = async () => {
    if (!editingRole) return

    try {
      const updateData = {
        ...formData,
        tenantId: currentTenant?.id,
        // REMOVED: permissions field - will handle separately
      }
      await roleService.updateRole(editingRole.id, updateData)
      setEditingRole(null)
      resetForm()
      loadRoles()
    } catch (error) {
      console.error('Error updating role:', error)
    }
  }

  const handleDeleteRole = async (roleId: string) => {
    if (!confirm('Are you sure you want to delete this role?')) return

    try {
      await roleService.deleteRole(roleId)
      loadRoles()
    } catch (error) {
      console.error('Error deleting role:', error)
    }
  }

  const resetForm = () => {
    setFormData({
      name: '',
      displayName: '',
      description: '',
      type: 'TENANT',
      level: 'USER',
      isActive: true
    })
  }

  const startEdit = (role: Role) => {
    setEditingRole(role)
    setFormData({
      name: role.name,
      displayName: role.displayName,
      description: role.description || '',
      type: role.type as 'SYSTEM' | 'TENANT' | 'CUSTOM',
      level: role.level,
      isActive: role.isActive
    })
  }

  // Bulk action handlers
  const handleSelectAll = (checked: boolean) => {
    if (checked) {
      // Only select non-system roles that can be modified
      const selectableRoles = paginatedRoles.filter(role => role.type !== 'SYSTEM')
      setSelectedRoles(selectableRoles.map(role => role.id))
      // Check if all selectable roles are selected
      setIsAllSelected(selectableRoles.length === paginatedRoles.filter(role => role.type !== 'SYSTEM').length)
    } else {
      setSelectedRoles([])
      setIsAllSelected(false)
    }
  }

  const handleSelectRole = (roleId: string, checked: boolean) => {
    if (checked) {
      const newSelection = [...selectedRoles, roleId]
      setSelectedRoles(newSelection)
      // Check if all selectable roles are now selected
      const selectableRoles = paginatedRoles.filter(role => role.type !== 'SYSTEM')
      setIsAllSelected(newSelection.length === selectableRoles.length)
    } else {
      const newSelection = selectedRoles.filter(id => id !== roleId)
      setSelectedRoles(newSelection)
      setIsAllSelected(false)
    }
  }

  const handleBulkDelete = () => {
    if (selectedRoles.length === 0) return
    setDeleteAction('delete')
    setIsDeleteDialogOpen(true)
  }

  const handleBulkSoftDelete = () => {
    if (selectedRoles.length === 0) return
    setDeleteAction('softDelete')
    setIsDeleteDialogOpen(true)
  }

  const confirmBulkDelete = async () => {
    if (selectedRoles.length === 0) return

    try {
      await Promise.all(selectedRoles.map(roleId => roleService.deleteRole(roleId)))
      setSelectedRoles([])
      setIsAllSelected(false)
      loadRoles()
      setIsDeleteDialogOpen(false)
      toast.success(`${deleteAction === 'delete' ? 'Deleted' : 'Soft deleted'} ${selectedRoles.length} roles successfully`)
    } catch (error: any) {
      console.error('Error bulk deleting roles:', error)
      toast.error(`Error ${deleteAction === 'delete' ? 'deleting' : 'soft deleting'} roles: ${error.message}`)
    }
  }

  const handleBulkActivate = async () => {
    if (selectedRoles.length === 0) return

    try {
      await Promise.all(selectedRoles.map(roleId =>
        roleService.updateRole(roleId, { isActive: true })
      ))
      setSelectedRoles([])
      setIsAllSelected(false)
      loadRoles()
      toast.success(`Activated ${selectedRoles.length} roles successfully`)
    } catch (error: any) {
      console.error('Error bulk activating roles:', error)
      toast.error(`Error activating roles: ${error.message}`)
    }
  }

  const handleBulkDeactivate = async () => {
    if (selectedRoles.length === 0) return

    if (!confirm(`Are you sure you want to deactivate ${selectedRoles.length} selected roles?`)) return

    try {
      await Promise.all(selectedRoles.map(roleId =>
        roleService.updateRole(roleId, { isActive: false })
      ))
      setSelectedRoles([])
      setIsAllSelected(false)
      loadRoles()
      toast.success(`Deactivated ${selectedRoles.length} roles successfully`)
    } catch (error: any) {
      console.error('Error bulk deactivating roles:', error)
      toast.error(`Error deactivating roles: ${error.message}`)
    }
  }

  const getTypeColor = (type: string) => {
    switch (type) {
      case 'SYSTEM': return 'bg-purple-100 text-purple-700 border-purple-200'
      case 'TENANT': return 'bg-green-100 text-green-700 border-green-200'
      case 'CUSTOM': return 'bg-blue-100 text-blue-700 border-blue-200'
      default: return 'bg-gray-100 text-gray-700 border-gray-200'
    }
  }

  const getLevelColor = (level: string) => {
    switch (level) {
      case 'SUPER_ADMIN': return 'bg-red-100 text-red-700'
      case 'ADMIN': return 'bg-orange-100 text-orange-700'
      case 'MANAGER': return 'bg-yellow-100 text-yellow-700'
      case 'USER': return 'bg-blue-100 text-blue-700'
      case 'GUEST': return 'bg-green-100 text-green-700'
      default: return 'bg-gray-100 text-gray-700'
    }
  }

  if (loading) {
    return (
      <div className="space-y-6">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-200 rounded w-1/3 mb-6"></div>
          <div className="grid gap-4">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="h-24 bg-gray-200 rounded-lg"></div>
            ))}
          </div>
        </div>
      </div>
    )
  }

  // Restore role handlers
  const handleRestoreRole = async (roleId: string) => {
    try {
      const success = await roleService.restoreRole(roleId)
      if (success) {
        toast.success('Role restored successfully')
        loadDeletedRoles()
        loadRoles() // Refresh active roles
      }
    } catch (error: any) {
      console.error('Error restoring role:', error)
      toast.error(`Error restoring role: ${error.message}`)
    }
  }

  const handleBulkRestore = async () => {
    if (selectedDeletedRoles.length === 0) return

    if (!confirm(`Are you sure you want to restore ${selectedDeletedRoles.length} selected roles?`)) return

    try {
      await Promise.all(selectedDeletedRoles.map(roleId => roleService.restoreRole(roleId)))
      setSelectedDeletedRoles([])
      loadDeletedRoles()
      loadRoles() // Refresh active roles
      toast.success(`Restored ${selectedDeletedRoles.length} roles successfully`)
    } catch (error: any) {
      console.error('Error bulk restoring roles:', error)
      toast.error(`Error restoring roles: ${error.message}`)
    }
  }

  const handleSelectDeletedRole = (roleId: string, checked: boolean) => {
    if (checked) {
      setSelectedDeletedRoles(prev => [...prev, roleId])
    } else {
      setSelectedDeletedRoles(prev => prev.filter(id => id !== roleId))
    }
  }

  const handleSelectAllDeletedRoles = (checked: boolean) => {
    if (checked) {
      setSelectedDeletedRoles(deletedRoles.map(role => role.id))
    } else {
      setSelectedDeletedRoles([])
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <ShieldCheckIcon className="w-6 h-6 text-blue-600" />
            Role Management
          </h2>
          <p className="text-gray-600 mt-1">Manage system and custom roles with permissions</p>
        </div>

        {hasFullAccess && (
          <Dialog open={isCreateDialogOpen || !!editingRole} onOpenChange={(open) => {
            console.log('ðŸ”— Dialog open state changed:', open)
            if (!open) {
              setIsCreateDialogOpen(false)
              setEditingRole(null)
              resetForm()
            }
          }}>
            <DialogTrigger asChild>
              <Button
                className="flex items-center gap-2"
                onClick={() => {
                  console.log('ðŸ”˜ Create Role button clicked!')
                  setIsCreateDialogOpen(true)
                }}
              >
                <PlusIcon className="w-4 h-4" />
                Create Role
              </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[425px]">
              <DialogHeader>
                <DialogTitle>
                  {editingRole ? 'Edit Role' : 'Create New Role'}
                </DialogTitle>
                <DialogDescription>
                  {editingRole
                    ? 'Update the role details and permissions.'
                    : 'Create a new role with specific access levels and permissions.'
                  }
                </DialogDescription>
              </DialogHeader>

              <div className="grid gap-4 py-4">
                <div className="grid gap-2">
                  <Label htmlFor="name">Role Name</Label>
                  <Input
                    id="name"
                    value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    placeholder="e.g., content_manager"
                  />
                </div>

                <div className="grid gap-2">
                  <Label htmlFor="displayName">Display Name</Label>
                  <Input
                    id="displayName"
                    value={formData.displayName}
                    onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}
                    placeholder="e.g., Content Manager"
                  />
                </div>

                <div className="grid gap-2">
                  <Label htmlFor="description">Description</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                    placeholder="Describe the role's responsibilities..."
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label htmlFor="type">Type</Label>
                    <Select
                      value={formData.type}
                      onValueChange={(value: 'SYSTEM' | 'TENANT' | 'CUSTOM') =>
                        setFormData({ ...formData, type: value })
                      }
                      disabled={editingRole?.type === 'SYSTEM'}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="SYSTEM">System</SelectItem>
                        <SelectItem value="TENANT">Tenant</SelectItem>
                        <SelectItem value="CUSTOM">Custom</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="grid gap-2">
                    <Label htmlFor="level">Access Level</Label>
                    <Select
                      value={formData.level}
                      onValueChange={(value: 'SUPER_ADMIN' | 'ADMIN' | 'MANAGER' | 'USER' | 'GUEST') =>
                        setFormData({ ...formData, level: value })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="GUEST">Guest</SelectItem>
                        <SelectItem value="USER">User</SelectItem>
                        <SelectItem value="MANAGER">Manager</SelectItem>
                        <SelectItem value="ADMIN">Admin</SelectItem>
                        <SelectItem value="SUPER_ADMIN">Super Admin</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </div>

              <DialogFooter>
                <Button variant="outline" onClick={() => {
                  setIsCreateDialogOpen(false)
                  setEditingRole(null)
                  resetForm()
                }}>
                  Cancel
                </Button>
                <Button onClick={editingRole ? handleUpdateRole : handleCreateRole}>
                  {editingRole ? 'Update Role' : 'Create Role'}
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        )}

        {/* Delete Confirmation Dialog */}
        <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
          <DialogContent className="sm:max-w-[425px]">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <ExclamationTriangleIcon className="w-5 h-5 text-red-600" />
                Confirm {deleteAction === 'delete' ? 'Delete' : 'Archive'}
              </DialogTitle>
              <DialogDescription>
                Are you sure you want to {deleteAction === 'delete' ? 'permanently delete' : 'archive'} {selectedRoles.length} selected role{selectedRoles.length > 1 ? 's' : ''}?
                {deleteAction === 'delete' ? (
                  <span className="text-red-600 font-medium"> This action cannot be undone.</span>
                ) : (
                  <span className="text-orange-600 font-medium"> Archived roles can be restored later.</span>
                )}
              </DialogDescription>
            </DialogHeader>
            <div className="py-4">
              <div className="bg-gray-50 rounded-lg p-3 max-h-32 overflow-y-auto">
                <p className="text-sm font-medium text-gray-700 mb-2">Selected roles:</p>
                <ul className="text-sm text-gray-600 space-y-1">
                  {selectedRoles.slice(0, 5).map(roleId => {
                    const role = roles.find(r => r.id === roleId)
                    return (
                      <li key={roleId} className="flex items-center gap-2">
                        <div className="w-2 h-2 bg-gray-400 rounded-full"></div>
                        {role?.displayName || role?.name || 'Unknown role'}
                      </li>
                    )
                  })}
                  {selectedRoles.length > 5 && (
                    <li className="text-gray-500 italic">
                      ...and {selectedRoles.length - 5} more
                    </li>
                  )}
                </ul>
              </div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setIsDeleteDialogOpen(false)}>
                Cancel
              </Button>
              <Button
                variant={deleteAction === 'delete' ? 'destructive' : 'default'}
                onClick={confirmBulkDelete}
                className={deleteAction === 'softDelete' ? 'bg-orange-600 hover:bg-orange-700' : ''}
              >
                {deleteAction === 'delete' ? (
                  <>
                    <TrashIcon className="w-4 h-4 mr-2" />
                    Delete {selectedRoles.length} Role{selectedRoles.length > 1 ? 's' : ''}
                  </>
                ) : (
                  <>
                    <ArchiveBoxIcon className="w-4 h-4 mr-2" />
                    Archive {selectedRoles.length} Role{selectedRoles.length > 1 ? 's' : ''}
                  </>
                )}
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>

      {/* Stats Cards */}
      <div className="grid gap-4 md:grid-cols-4">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="p-2 bg-blue-100 rounded-lg">
                <UserGroupIcon className="w-5 h-5 text-blue-600" />
              </div>
              <div>
                <p className="text-sm font-medium text-gray-600">Total Roles</p>
                <p className="text-2xl font-bold text-gray-900">{roles.length}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="p-2 bg-green-100 rounded-lg">
                <CheckCircleIcon className="w-5 h-5 text-green-600" />
              </div>
              <div>
                <p className="text-sm font-medium text-gray-600">Active</p>
                <p className="text-2xl font-bold text-gray-900">
                  {roles.filter(r => r.isActive).length}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="p-2 bg-red-100 rounded-lg">
                <XCircleIcon className="w-5 h-5 text-red-600" />
              </div>
              <div>
                <p className="text-sm font-medium text-gray-600">System</p>
                <p className="text-2xl font-bold text-gray-900">
                  {roles.filter(r => r.type === 'SYSTEM').length}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center">
              <div className="p-2 bg-purple-100 rounded-lg">
                <ShieldCheckIcon className="w-5 h-5 text-purple-600" />
              </div>
              <div>
                <p className="text-sm font-medium text-gray-600">Custom</p>
                <p className="text-2xl font-bold text-gray-900">
                  {roles.filter(r => r.type === 'CUSTOM').length}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Roles Table with Tabs */}
      <Card className="border-0 shadow-lg">
        <CardHeader>
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <div>
                <CardTitle className="text-xl font-bold text-gray-900">
                  Role Management
                </CardTitle>
                <CardDescription>
                  Manage system and custom roles with permissions
                </CardDescription>
              </div>
              <div className="flex items-center space-x-2">
                <span className="text-sm text-gray-500">
                  Total: {roles.length + deletedRoles.length} roles
                </span>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex space-x-1 border-b border-gray-200 mt-4">
              <button
                onClick={() => setActiveTab('active')}
                className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${
                  activeTab === 'active'
                    ? 'text-blue-600 bg-blue-50 border-b-2 border-blue-600'
                    : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center space-x-2">
                  <ShieldCheckIcon className="w-4 h-4" />
                  <span>Active Roles</span>
                  <Badge className={
                    activeTab === 'active'
                      ? 'bg-blue-100 text-blue-800'
                      : 'bg-gray-100 text-gray-600'
                  }>
                    {roles.length}
                  </Badge>
                </div>
              </button>

              <button
                onClick={() => setActiveTab('trash')}
                className={`px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${
                  activeTab === 'trash'
                    ? 'text-red-600 bg-red-50 border-b-2 border-red-600'
                    : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center space-x-2">
                  <TrashIcon className="w-4 h-4" />
                  <span>Trash</span>
                  <Badge className={
                    activeTab === 'trash'
                      ? 'bg-red-100 text-red-800'
                      : 'bg-gray-100 text-gray-600'
                  }>
                    {deletedRoles.length}
                  </Badge>
                </div>
              </button>
            </div>
          </CardHeader>
          <CardContent>
            {/* Active Roles Content */}
            {activeTab === 'active' && (
              <div className="space-y-4">
                {/* Search and Bulk Actions */}
                <div className="flex items-center justify-between gap-4">
            <div className="relative flex-1 max-w-sm">
              <MagnifyingGlassIcon className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
              <Input
                placeholder="Search active roles..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10"
              />
            </div>

            {selectedRoles.length > 0 && hasFullAccess && (
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-600">
                  {selectedRoles.length} selected
                </span>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleBulkActivate}
                >
                  Activate
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleBulkDeactivate}
                >
                  Deactivate
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleBulkSoftDelete}
                  className="text-orange-600 hover:text-orange-700 hover:bg-orange-50"
                >
                  Archive
                </Button>
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={handleBulkDelete}
                >
                  Delete
                </Button>
              </div>
            )}
          </div>

          {/* Active Roles Table */}
          <Card>
        <CardContent className="p-0">
          {paginatedRoles.length === 0 ? (
            <div className="p-8 text-center">
              <ShieldCheckIcon className="w-12 h-12 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-900 mb-2">No roles found</h3>
              <p className="text-gray-600">
                {searchTerm ? 'Try adjusting your search terms.' : 'Create your first role to get started.'}
              </p>
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[50px]">
                    {hasFullAccess && paginatedRoles.some(role => role.type !== 'SYSTEM') && (
                      <Checkbox
                        checked={isAllSelected}
                        onCheckedChange={handleSelectAll}
                      />
                    )}
                  </TableHead>
                  <TableHead className="w-[200px]">Display Name</TableHead>
                  <TableHead className="w-[150px]">Role Name</TableHead>
                  <TableHead className="w-[100px]">Type</TableHead>
                  <TableHead className="w-[120px]">Level</TableHead>
                  <TableHead className="w-[300px]">Description</TableHead>
                  <TableHead className="w-[120px]">Created</TableHead>
                  <TableHead className="w-[100px]">Permissions</TableHead>
                  <TableHead className="w-[120px]">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {paginatedRoles.map((role) => (
                  <TableRow key={role.id} className="hover:bg-gray-50">
                    <TableCell className="font-medium">
                      {hasFullAccess && (
                        <Checkbox
                          checked={selectedRoles.includes(role.id)}
                          onCheckedChange={(checked) => handleSelectRole(role.id, checked as boolean)}
                          disabled={role.type === 'SYSTEM'}
                        />
                      )}
                    </TableCell>
                    <TableCell className="font-medium">
                      <div>
                        <div className="font-semibold text-gray-900">{role.displayName}</div>
                        {/* Tenant info removed - tenant object not available in Role type */}
                      </div>
                    </TableCell>
                    <TableCell>
                      <code className="text-sm bg-gray-100 px-2 py-1 rounded">{role.name}</code>
                    </TableCell>
                    <TableCell>
                      <Badge className={getTypeColor(role.type)} variant="secondary">
                        {role.type}
                      </Badge>
                    </TableCell>
                    <TableCell>
                      <Badge className={getLevelColor(role.level)} variant="secondary">
                        {role.level}
                      </Badge>
                    </TableCell>
                    <TableCell>
                      <div className="max-w-xs truncate" title={role.description}>
                        {role.description || '-'}
                      </div>
                    </TableCell>
                    <TableCell>
                      <div className="text-sm text-gray-600">
                        {new Date(role.createdAt).toLocaleDateString()}
                      </div>
                    </TableCell>
                    <TableCell>
                      <div className="text-sm text-gray-600">
                        {role.permissions?.length || 0}
                      </div>
                    </TableCell>
                    <TableCell>
                      <div className="flex items-center gap-1">
                        {hasFullAccess && (
                          <>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => startEdit(role)}
                              disabled={role.type === 'SYSTEM'}
                              className="h-8 w-8 p-0"
                            >
                              <PencilIcon className="w-3 h-3" />
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => handleDeleteRole(role.id)}
                              disabled={role.type === 'SYSTEM'}
                              className="h-8 w-8 p-0 text-red-600 hover:text-red-700"
                            >
                              <TrashIcon className="w-3 h-3" />
                            </Button>
                          </>
                        )}
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}

      {/* Pagination for Active Roles */}
      {totalPages > 1 && (
        <div className="mt-4">
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            onPageChange={setCurrentPage}
          />
        </div>
      )}
        </CardContent>
      </Card>

      {/* Trash Tab Content */}
      {activeTab === 'trash' && (
        <div className="space-y-4">
          <Card className="border-0 shadow-lg mt-6">
            <CardHeader>
              <div className="flex items-center space-x-2">
                <TrashIcon className="w-5 h-5 text-red-600" />
                <CardTitle className="text-xl font-bold text-gray-900">
                Trash - Deleted Roles
              </CardTitle>
            </div>
          </CardHeader>
            <CardContent>
              {/* Trash Search and Actions */}
              <div className="flex items-center justify-between gap-4">
                <div className="relative flex-1 max-w-sm">
                  <MagnifyingGlassIcon className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
              <Input
                placeholder="Search trash..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10"
              />
            </div>

            {selectedDeletedRoles.length > 0 && hasFullAccess && (
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-600">
                  {selectedDeletedRoles.length} selected
                </span>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleBulkRestore}
                  className="text-green-600 hover:text-green-700 hover:bg-green-50"
                >
                  Restore All
                </Button>
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={() => {
                    if (confirm(`Are you sure you want to permanently delete ${selectedDeletedRoles.length} selected roles? This action cannot be undone.`)) {
                      // Handle permanent delete if needed
                    }
                  }}
                >
                  Delete Permanently
                </Button>
              </div>
            )}
          </div>

          {/* Trash Table */}
          <Card>
            <CardContent className="p-0">
              {deletedRolesLoading ? (
                <div className="p-8 text-center">
                  <div className="animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading trash...</p>
                </div>
              ) : deletedRoles.length === 0 ? (
                <div className="p-8 text-center">
                  <TrashIcon className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                  <h3 className="text-lg font-medium text-gray-900 mb-2">No roles in trash</h3>
                  <p className="text-gray-600">
                    Deleted roles will appear here for restoration.
                  </p>
                </div>
              ) : (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead className="w-[50px]">
                        <Checkbox
                          checked={selectedDeletedRoles.length === deletedRoles.length && deletedRoles.length > 0}
                          onCheckedChange={handleSelectAllDeletedRoles}
                        />
                      </TableHead>
                      <TableHead className="w-[200px]">Display Name</TableHead>
                      <TableHead className="w-[150px]">Role Name</TableHead>
                      <TableHead className="w-[100px]">Type</TableHead>
                      <TableHead className="w-[120px]">Level</TableHead>
                      <TableHead className="w-[120px]">Deleted At</TableHead>
                      <TableHead>Description</TableHead>
                      <TableHead className="w-[100px]">Actions</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {deletedRoles.map((role) => (
                      <TableRow key={role.id} className="hover:bg-gray-50">
                        <TableCell>
                          <Checkbox
                            checked={selectedDeletedRoles.includes(role.id) || false}
                            onCheckedChange={(checked: boolean) => handleSelectDeletedRole(role.id, checked)}
                          />
                        </TableCell>
                        <TableCell className="font-medium">{role.displayName}</TableCell>
                        <TableCell className="font-mono text-sm">{role.name}</TableCell>
                        <TableCell>
                          <Badge className={getTypeColor(role.type)}>
                            {role.type}
                          </Badge>
                        </TableCell>
                        <TableCell>
                          <Badge className={getLevelColor(role.level)}>
                            {role.level}
                          </Badge>
                        </TableCell>
                        <TableCell>
                          <div className="text-sm text-gray-600">
                            {new Date(role.deletedAt || '').toLocaleDateString()}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="text-sm text-gray-600 max-w-xs truncate">
                            {role.description || '-'}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="flex items-center gap-1">
                            {hasFullAccess && (
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={() => handleRestoreRole(role.id)}
                                className="h-8 w-8 p-0 text-green-600 hover:text-green-700"
                                title="Restore role"
                              >
                                <ArchiveBoxIcon className="w-3 h-3" />
                              </Button>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </CardContent>
          </Card>
          </div>
        )}

      {/* Create/Edit Dialog */}
      <Dialog open={isCreateDialogOpen || !!editingRole} onOpenChange={(open) => {
        console.log('ðŸ”— Dialog open state changed:', open)
        if (!open) {
          setIsCreateDialogOpen(false)
          setEditingRole(null)
          resetForm()
        } else {
          setIsCreateDialogOpen(true)
        }
      }}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>
              {editingRole ? 'Edit Role' : 'Create New Role'}
            </DialogTitle>
            <DialogDescription>
              {editingRole ? 'Update the role details and permissions.' : 'Create a new role with specific permissions and access levels.'}
            </DialogDescription>
          </DialogHeader>

          <div className="grid gap-4 py-4">
            <div className="grid gap-2">
              <Label htmlFor="displayName">Display Name</Label>
              <Input
                id="displayName"
                value={formData.displayName}
                onChange={(e) => setFormData({ ...formData, displayName: e.target.value })}
                placeholder="e.g., Content Manager"
              />
            </div>

            <div className="grid gap-2">
              <Label htmlFor="name">Role Name (Internal)</Label>
              <Input
                id="name"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                placeholder="e.g., content_manager"
                disabled={!!editingRole}
              />
            </div>

            <div className="grid gap-2">
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                placeholder="Describe the role responsibilities and access level"
                rows={3}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="grid gap-2">
                <Label htmlFor="type">Role Type</Label>
                <Select
                  value={formData.type}
                  onValueChange={(value: 'SYSTEM' | 'TENANT' | 'CUSTOM') =>
                    setFormData({ ...formData, type: value })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="TENANT">Tenant Role</SelectItem>
                    <SelectItem value="CUSTOM">Custom Role</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="grid gap-2">
                <Label htmlFor="level">Access Level</Label>
                <Select
                  value={formData.level}
                  onValueChange={(value: 'SUPER_ADMIN' | 'ADMIN' | 'MANAGER' | 'USER' | 'GUEST') =>
                    setFormData({ ...formData, level: value })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="GUEST">Guest</SelectItem>
                    <SelectItem value="USER">User</SelectItem>
                    <SelectItem value="MANAGER">Manager</SelectItem>
                    <SelectItem value="ADMIN">Admin</SelectItem>
                    <SelectItem value="SUPER_ADMIN">Super Admin</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => {
              setIsCreateDialogOpen(false)
              setEditingRole(null)
              resetForm()
            }}>
              Cancel
            </Button>
            <Button onClick={editingRole ? handleUpdateRole : handleCreateRole}>
              {editingRole ? 'Update Role' : 'Create Role'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation Dialog */}
      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <ExclamationTriangleIcon className="w-5 h-5 text-red-600" />
              Confirm {deleteAction === 'delete' ? 'Delete' : 'Archive'}
            </DialogTitle>
            <DialogDescription>
              Are you sure you want to {deleteAction === 'delete' ? 'permanently delete' : 'archive'} {selectedRoles.length} selected role{selectedRoles.length > 1 ? 's' : ''}?
              {deleteAction === 'delete' ? (
                <span className="text-red-600 font-medium"> This action cannot be undone.</span>
              ) : (
                <span className="text-orange-600 font-medium"> Archived roles can be restored later.</span>
              )}
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <div className="bg-gray-50 rounded-lg p-3 max-h-32 overflow-y-auto">
              <p className="text-sm font-medium text-gray-700 mb-2">Selected roles:</p>
              <ul className="text-sm text-gray-600 space-y-1">
                {selectedRoles.slice(0, 5).map(roleId => {
                  const role = roles.find(r => r.id === roleId)
                  return (
                    <li key={roleId} className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-gray-400 rounded-full"></div>
                      {role?.displayName || role?.name || 'Unknown role'}
                    </li>
                  )
                })}
                {selectedRoles.length > 5 && (
                  <li className="text-gray-500 italic">
                    ...and {selectedRoles.length - 5} more
                  </li>
                )}
              </ul>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setIsDeleteDialogOpen(false)}>
              Cancel
            </Button>
            <Button
              variant={deleteAction === 'delete' ? 'destructive' : 'default'}
              onClick={confirmBulkDelete}
              className={deleteAction === 'softDelete' ? 'bg-orange-600 hover:bg-orange-700' : ''}
            >
              {deleteAction === 'delete' ? (
                <>
                  <TrashIcon className="w-4 h-4 mr-2" />
                  Delete {selectedRoles.length} Role{selectedRoles.length > 1 ? 's' : ''}
                </>
              ) : (
                <>
                  <ArchiveBoxIcon className="w-4 h-4 mr-2" />
                  Archive {selectedRoles.length} Role{selectedRoles.length > 1 ? 's' : ''}
                </>
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  )
}